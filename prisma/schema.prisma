generator client {
    provider = "prisma-client"
    output   = "./generated/prisma"
}

datasource db {
    provider = "sqlite"
}

model Document {
    id              String   @id
    title           String
    confidentiality Int      @default(0)
    integrity       Int      @default(0)
    availability    Int      @default(0)
    createdAt       DateTime @default(now()) @map("created_at")

    snapshot DocumentSnapshot?
    updates  DocumentUpdate[]
    versions DocumentVersion[]

    @@map("documents")
}

model DocumentSnapshot {
    documentId String   @id @map("document_id")
    document   Document @relation(fields: [documentId], references: [id], onDelete: Cascade)
    snapshot   Bytes    @map("snapshot_update")
    updatedAt  BigInt   @map("updated_at")

    @@map("document_snapshots")
}

model DocumentUpdate {
    id         Int      @id @default(autoincrement())
    documentId String   @map("document_id")
    document   Document @relation(fields: [documentId], references: [id], onDelete: Cascade)
    update     Bytes
    createdAt  BigInt   @map("created_at")

    @@index([documentId, id])
    @@map("document_updates")
}

model DocumentVersion {
    id         Int      @id @default(autoincrement())
    documentId String   @map("document_id")
    document   Document @relation(fields: [documentId], references: [id], onDelete: Cascade)
    snapshot   Bytes // Encoded Yjs snapshot
    label      String? // Optional user-provided label
    createdAt  BigInt   @map("created_at")

    @@index([documentId, createdAt(sort: Desc)])
    @@map("document_versions")
}

model ProjectionState {
    docId          String
    name           String
    version        Int
    lastAppliedRev BigInt  @map("last_applied_rev")
    lastAppliedAt  BigInt  @map("last_applied_at")
    lastError      String? @map("last_error")

    @@id([docId, name])
    @@map("projection_state")
}
